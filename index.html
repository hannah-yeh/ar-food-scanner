<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR -> Direct AR 測試</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
        }
        #video-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
        }
        #scan-button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50px;
            border: none;
            background-color: #007bff;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #status {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        /* AR Viewer 預設不顯示，但存在於頁面中 */
        model-viewer {
            position: absolute; top:0; left:0;
            width: 100%; height: 100%;
            display: none;
        }
    </style>
    <script src='https://unpkg.com/tesseract.js@5/dist/tesseract.min.js'></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
</head>
<body>

    <div class="container" id="initial-screen">
        <button id="start-button">開始掃描</button>
    </div>

    <div id="video-container" style="display: none;">
        <video id="video" playsinline></video>
        <div id="controls">
            <div id="status">請將相機對準關鍵字「皮卡丘」</div>
            <button id="scan-button">掃描</button>
        </div>
    </div>
    
    <canvas id="canvas" style="display: none;"></canvas>
    
    <model-viewer id="ar-viewer"
                  src="https://modelviewer.dev/shared-assets/models/Fox.glb" alt="A 3D model"
                  ar
                  ar-placement="floor">
    </model-viewer>

    <script>
        const initialScreen = document.getElementById('initial-screen');
        const startButton = document.getElementById('start-button');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanButton = document.getElementById('scan-button');
        const statusDiv = document.getElementById('status');
        const viewer = document.getElementById('ar-viewer');

        const KEYWORD = "皮卡丘";

        // 步驟 1: 點擊開始，請求相機權限
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                await video.play();
                initialScreen.style.display = 'none';
                videoContainer.style.display = 'block';
            } catch (err) {
                console.error("相機錯誤:", err);
                alert("無法啟動相機，請檢查權限設定。");
            }
        });

        // 步驟 2: 點擊掃描按鈕，執行 OCR
        scanButton.addEventListener('click', async () => {
            statusDiv.textContent = '辨識中，請稍候...';
            scanButton.disabled = true;

            // 將當前影像繪製到 canvas
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 使用 Tesseract.js 進行辨識 (使用繁體中文)
            const { data: { text } } = await Tesseract.recognize(
              canvas,
              'chi_tra', // 指定語言為繁體中文
              { logger: m => console.log(m) } // 在 console 顯示進度
            );

            console.log('辨識結果:', text);
            statusDiv.textContent = `辨識結果: ${text.replace(/\s/g, '')}`;

            // 步驟 3: 檢查辨識結果是否包含關鍵字
            if (text.includes(KEYWORD)) {
                statusDiv.textContent = '辨識成功！正在啟動 AR...';
                
                // 步驟 4: 辨識成功，直接啟動 AR
                try {
                    videoContainer.style.display = 'none'; // 隱藏相機畫面
                    viewer.style.display = 'block';     // 顯示 AR viewer
                    await viewer.activateAR();
                    console.log("AR 已啟動");
                } catch (error) {
                    console.error("啟動 AR 失敗:", error);
                    alert("AR 啟動失敗，您的裝置可能不支援。");
                }
            } else {
                statusDiv.textContent = `辨識失敗，請對準「${KEYWORD}」再試一次`;
                scanButton.disabled = false;
            }
        });

    </script>
</body>
</html>
