<!DOCTYPE html>
<html>
<head>
    <title>AR 食品成分偵測</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4"></script>
</head>
<body style='margin : 0px; overflow: hidden;'>

    <a-scene embedded arjs>

        <a-camera-static/>
        
        <a-entity id="feedback-entity" visible="false" position="0 0 -2">
            <a-box color="#FF4500" scale="0.5 0.5 0.5" rotation="0 45 0"></a-box>
            <a-text value="警告：檢測到不健康成分！" color="#FF4500" position="0 0.4 -0.5" align="center" width="2"></a-text>
        </a-entity>

    </a-scene>

    <button id="scanButton" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:99; padding:10px 20px;">
        開始掃描成分
    </button>

    <script>
        // 獲取畫面中的元素
        const scanButton = document.getElementById('scanButton');
        const scene = document.querySelector('a-scene');
    
        // 建立一個顯示文字的虛擬物件
        const textEntity = document.createElement('a-entity');
        textEntity.setAttribute('id', 'result-text');
        textEntity.setAttribute('visible', 'false');
        textEntity.setAttribute('position', '0 0 -2');
        textEntity.setAttribute('text', {
            value: '',
            color: '#FFFFFF',
            align: 'center',
            width: 3
        });
        scene.appendChild(textEntity);
    
        // 監聽按鈕點擊事件
        scanButton.addEventListener('click', async () => {
            console.log("正在掃描中...");
            
            // 隱藏之前的文字
            textEntity.setAttribute('visible', 'false');
    
            // 獲取攝影機畫面
            const video = document.querySelector('video');
            if (!video) {
                console.error("找不到攝影機畫面。");
                return;
            }
    
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
            // 使用 Tesseract.js 進行文字辨識
            const { data: { text } } = await Tesseract.recognize(canvas, 'chi_tra');
    
            console.log("辨識結果：", text);
    
            // 顯示辨識到的文字
            if (text && text.trim().length > 0) {
                textEntity.setAttribute('text', 'value', `偵測到文字：\n${text}`);
                textEntity.setAttribute('visible', 'true');
            } else {
                alert("未偵測到任何文字，請重新掃描。");
            }
        });
    </script>
</body>
</html>